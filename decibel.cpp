#include "arm_math.h"

#define MIN_DB_VALUE (-80)

//  int i;
//  float32_t n;
//
//  i = 0;
// 
//  do {
//    n = 32767 * pow(10, ((float32_t)i/20));
//    printf("%.0f, /* %i dB */\r\n", n, i);
//  } while (i-- > MIN_DB_VALUE);


static const q15_t db_table[] = {
    32767, /* 0 dB */
    29204, /* -1 dB */
    26028, /* -2 dB */
    23197, /* -3 dB */
    20675, /* -4 dB */
    18426, /* -5 dB */
    16422, /* -6 dB */
    14636, /* -7 dB */
    13045, /* -8 dB */
    11626, /* -9 dB */
    10362, /* -10 dB */
    9235, /* -11 dB */
    8231, /* -12 dB */
    7336, /* -13 dB */
    6538, /* -14 dB */
    5827, /* -15 dB */
    5193, /* -16 dB */
    4628, /* -17 dB */
    4125, /* -18 dB */
    3677, /* -19 dB */
    3277, /* -20 dB */
    2920, /* -21 dB */
    2603, /* -22 dB */
    2320, /* -23 dB */
    2067, /* -24 dB */
    1843, /* -25 dB */
    1642, /* -26 dB */
    1464, /* -27 dB */
    1304, /* -28 dB */
    1163, /* -29 dB */
    1036, /* -30 dB */
    923, /* -31 dB */
    823, /* -32 dB */
    734, /* -33 dB */
    654, /* -34 dB */
    583, /* -35 dB */
    519, /* -36 dB */
    463, /* -37 dB */
    413, /* -38 dB */
    368, /* -39 dB */
    328, /* -40 dB */
    292, /* -41 dB */
    260, /* -42 dB */
    232, /* -43 dB */
    207, /* -44 dB */
    184, /* -45 dB */
    164, /* -46 dB */
    146, /* -47 dB */
    130, /* -48 dB */
    116, /* -49 dB */
    104, /* -50 dB */
    92, /* -51 dB */
    82, /* -52 dB */
    73, /* -53 dB */
    65, /* -54 dB */
    58, /* -55 dB */
    52, /* -56 dB */
    46, /* -57 dB */
    41, /* -58 dB */
    37, /* -59 dB */
    33, /* -60 dB */
    29, /* -61 dB */
    26, /* -62 dB */
    23, /* -63 dB */
    21, /* -64 dB */
    18, /* -65 dB */
    16, /* -66 dB */
    15, /* -67 dB */
    13, /* -68 dB */
    12, /* -69 dB */
    10, /* -70 dB */
    9, /* -71 dB */
    8, /* -72 dB */
    7, /* -73 dB */
    7, /* -74 dB */
    6, /* -75 dB */
    5, /* -76 dB */
    5, /* -77 dB */
    4, /* -78 dB */
    4, /* -79 dB */
    3, /* -80 dB */
};

static int8_t find_nearest_db(q15_t value)
{
  int8_t i;
  
  for (i=0; i<(sizeof(db_table)/sizeof(q15_t)); i++)
  {
    if (value >= db_table[i])
    {
      return -i;
    }
  }
  
  return MIN_DB_VALUE;
}

void q15_to_dBfs(q15_t *in, int8_t *out, uint32_t size)
{
  while (size-- > 0)
  {
    *out++ = find_nearest_db(*in++);
  }
}
